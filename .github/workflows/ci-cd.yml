name: Cross-Platform CI

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        java-version: [17]

    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK ${{ matrix.java-version }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ matrix.java-version }}
          distribution: 'temurin'

      - name: Build and test
        shell: bash
        run: |
          # Все команды в одном bash shell для кросс-платформенности
          echo "=== Starting build on ${{ runner.os }} ==="
          
          # Компиляция
          mvn clean compile
          
          # Тесты
          mvn test
          
          # Сборка JAR
          mvn package -DskipTests
          
          echo "=== Build completed ==="

      - name: Verify and test
        shell: bash
        run: |
          echo "=== Verification ==="
          
          # Проверка JAR файла
          JAR_FILE="target/calculator-1.0.0.jar"
          
          if [[ -f "$JAR_FILE" ]]; then
            echo "JAR file exists: $JAR_FILE"
          
            # Простая проверка размера файла
            if [[ "${{ runner.os }}" == "Windows" ]]; then
              # Windows
              file_size=$(powershell "(Get-Item '$JAR_FILE').Length")
            else
              # Linux/Mac
              file_size=$(stat -f%z "$JAR_FILE" 2>/dev/null || stat -c%s "$JAR_FILE" 2>/dev/null)
            fi
          
            echo "JAR file size: $file_size bytes"
          
            # Быстрый тест запуска
            echo "Quick test:"
            java -jar "$JAR_FILE" 2>&1 | grep -i "calculator\|success\|error" | head -3 || echo "Test executed"
          
          else
            echo "ERROR: JAR file not found!"
            exit 1
          fi

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: calculator-${{ runner.os }}-jdk${{ matrix.java-version }}
          path: target/*.jar

  # Деплой на self-hosted runner
  deploy:
    runs-on: self-hosted
    needs: build

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build Docker Image
        run: docker build -t calculator-app:latest .

      - name: Stop and remove old container
        run: |
          docker stop calculator-container || true
          docker rm calculator-container || true

      - name: Run Docker Container
        run: |
          docker run -d \
            --name calculator-container \
            --restart unless-stopped \
            calculator-app:latest

      - name: Verify deployment
        run: |
          sleep 3
          echo "Container status:"
          docker ps --filter "name=calculator-container"
          
          echo "Container logs (last 10 lines):"
          docker logs --tail 10 calculator-container || echo "No logs yet"